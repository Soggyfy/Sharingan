name: Release

on:
    release:
        types: [published]

permissions:
    contents: write
    packages: write

jobs:
    publish:
        runs-on: windows-latest

        steps:
            - uses: actions/checkout@v6

            - name: Setup .NET
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: "10.0.x"

            - name: Restore
              run: dotnet restore

            - name: Build
              run: dotnet build --no-restore --configuration Release

            - name: Test
              run: dotnet test --no-build --configuration Release

            - name: Pack
              run: |
                  $version = "${{ github.event.release.tag_name }}".TrimStart('v')
                  dotnet pack --no-build --configuration Release --output ./artifacts -p:PackageVersion=$version

            - name: Push to NuGet
              run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

            - name: Push to GitHub Packages
              run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.GITHUB_TOKEN }} --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json --skip-duplicate

            - name: Upload packages to GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      ./artifacts/*.nupkg
                      ./artifacts/*.snupkg

            - name: Update release description
              if: github.event.release.body == ''
              uses: softprops/action-gh-release@v2
              with:
                  body: |
                      ## üì¶ Sharingan ${{ github.event.release.tag_name }}

                      **Cross-Platform Local Settings Library for .NET**

                      A robust, multi-process-safe, async-first settings library for managing application, user, and device settings locally.

                      ---

                      ### üì• Installation

                      ```bash
                      dotnet add package Sharingan --version ${{ github.event.release.tag_name }}
                      ```

                      ---

                      ### üìã Packages

                      | Package | Description |
                      |---------|-------------|
                      | `Sharingan` | Core library with JSON, InMemory, Environment, and Composite providers |
                      | `Sharingan.Abstractions` | Core interfaces and abstractions |
                      | `Sharingan.Providers.Registry` | Windows Registry provider |
                      | `Sharingan.Providers.Ini` | INI file provider |
                      | `Sharingan.Providers.Yaml` | YAML file provider |
                      | `Sharingan.Providers.Xml` | XML file provider |
                      | `Sharingan.Providers.Toml` | TOML file provider |
                      | `Sharingan.Providers.SQLite` | SQLite database provider |
                      | `Sharingan.Providers.Encrypted` | Encryption wrapper provider |
                      | `Sharingan.Extensions.DependencyInjection` | Microsoft DI integration |
                      | `Sharingan.Extensions.Configuration` | Microsoft.Extensions.Configuration bridge |

                      ---

                      ### üéØ Supported Frameworks

                      | Framework | Support |
                      |-----------|---------|
                      | .NET Framework 4.8 | ‚úÖ |
                      | .NET Framework 4.8.1 | ‚úÖ |
                      | .NET Standard 2.0 | ‚úÖ |
                      | .NET Standard 2.1 | ‚úÖ |
                      | .NET 7.0 | ‚úÖ |
                      | .NET 8.0 | ‚úÖ |
                      | .NET 9.0 | ‚úÖ |
                      | .NET 10.0 | ‚úÖ |

                      ---

                      ### üåê Supported Platforms

                      | Platform | Support |
                      |----------|---------|
                      | Windows | ‚úÖ |
                      | Linux | ‚úÖ |
                      | macOS | ‚úÖ |
                      | Android | ‚úÖ |
                      | iOS | ‚úÖ |

                      ---

                      ### üîó Links

                      - [üìñ Documentation](https://github.com/${{ github.repository }})
                      - [üì¶ NuGet](https://www.nuget.org/packages/Sharingan)
                      - [üìù Changelog](https://github.com/${{ github.repository }}/blob/develop/CHANGELOG.md)
